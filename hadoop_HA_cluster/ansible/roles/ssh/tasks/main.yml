---
- name: Ensure SSH directory exists
  file:
    path: "/home/{{ cluster_user }}/.ssh"
    state: directory
    owner: "{{ cluster_user }}"
    group: "{{ cluster_user }}"
    mode: 0700

- name: Generate SSH key on ALL nodes
  openssh_keypair:
    path: "/home/{{ cluster_user }}/.ssh/id_rsa"
    type: rsa
    size: 4096
    owner: "{{ cluster_user }}"
    group: "{{ cluster_user }}"
    mode: 0600

- name: Collect all public keys to the vagrant shared folder
  copy:
    src: "/home/{{ cluster_user }}/.ssh/id_rsa.pub"
    dest: "/vagrant/id_rsa_{{ inventory_hostname }}.pub"
    remote_src: yes

- name: Add ALL cluster keys to authorized_keys on every node
  shell: |
    cat /vagrant/id_rsa_NameNode.pub >> /home/{{ cluster_user }}/.ssh/authorized_keys
    cat /vagrant/id_rsa_StandBy.pub >> /home/{{ cluster_user }}/.ssh/authorized_keys
    cat /vagrant/id_rsa_DataNode1.pub >> /home/{{ cluster_user }}/.ssh/authorized_keys
    cat /vagrant/id_rsa_DataNode2.pub >> /home/{{ cluster_user }}/.ssh/authorized_keys
    sort -u /home/{{ cluster_user }}/.ssh/authorized_keys -o /home/{{ cluster_user }}/.ssh/authorized_keys
    chmod 600 /home/{{ cluster_user }}/.ssh/authorized_keys
